name: Deploy NotionNext

on:
  schedule:
    - cron: '0 * * * *'  # 每小时运行一次（UTC）
  workflow_dispatch:

jobs:
  check-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 💾 Restore last edited time from cache
        uses: actions/cache@v3
        with:
          path: .cache
          key: notion-last-edited-cache

      - name: 🔍 Check Notion last_edited_time and deploy if changed
        run: |
          set -euo pipefail
          mkdir -p .cache

          NOTION_TOKEN="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"
          NOTION_DATABASE_ID="24ee6481ffbd80e299a8c77c37baf01b"

          LAST_EDITED=$(curl -s "https://api.notion.com/v1/databases/$NOTION_DATABASE_ID/query" \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Notion-Version: 2022-06-28" \
            -H "Content-Type: application/json" \
            | jq -r '.results[0].last_edited_time')

          echo "📅 Last edited: $LAST_EDITED"
          echo "$LAST_EDITED" > .cache/current_last_edited.txt

          if [ -f .cache/previous_last_edited.txt ]; then
            PREV_EDITED=$(cat .cache/previous_last_edited.txt)
          else
            PREV_EDITED=""
          fi

          if [ "$LAST_EDITED" != "$PREV_EDITED" ]; then
            echo "🔄 Detected change in Notion. Triggering EdgeOne build..."
            curl -X POST "https://pages-api.edgeone.ai/v1/webhook/32d294f9005676799bb75b8f806a098799f96995e80a9cd1c924f8515c3eba5e"
            cp .cache/current_last_edited.txt .cache/previous_last_edited.txt
          else
            echo "✅ No change detected. Skipping build."
          fi
